{% extends "base.html" %}

{% block title %}Reports & Analytics - Facial Recognition Attendance System{% endblock %}

{% block extra_css %}
<style>
    .report-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    .report-card:hover {
        transform: translateY(-5px);
    }
    .chart-container {
        position: relative;
        height: 400px;
        margin: 2rem 0;
    }
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        text-align: center;
        margin-bottom: 1rem;
    }
    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    .metric-label {
        font-size: 1rem;
        opacity: 0.9;
    }
    .metric-change {
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    .report-filters {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .department-stats {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid #0d6efd;
    }
    .employee-rank {
        display: flex;
        align-items: center;
        padding: 1rem;
        background: white;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .rank-number {
        background: #0d6efd;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 1rem;
    }
    .trend-up {
        color: #28a745;
    }
    .trend-down {
        color: #dc3545;
    }
    .trend-neutral {
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>
            <i class="fas fa-chart-line me-2"></i>Reports & Analytics
        </h2>
        <p class="text-muted">Comprehensive attendance analytics and insights</p>
    </div>
</div>

<!-- Report Filters -->
<div class="report-filters">
    <div class="row">
        <div class="col-md-3">
            <label for="reportDateFrom" class="form-label">From Date</label>
            <input type="date" class="form-control" id="reportDateFrom">
        </div>
        <div class="col-md-3">
            <label for="reportDateTo" class="form-label">To Date</label>
            <input type="date" class="form-control" id="reportDateTo">
        </div>
        <div class="col-md-2">
            <label for="reportDepartment" class="form-label">Department</label>
            <select class="form-control" id="reportDepartment">
                <option value="">All Departments</option>
                <option value="Human Resources">HR</option>
                <option value="Information Technology">IT</option>
                <option value="Finance">Finance</option>
                <option value="Marketing">Marketing</option>
                <option value="Operations">Operations</option>
                <option value="Sales">Sales</option>
            </select>
        </div>
        <div class="col-md-2">
            <label for="reportPeriod" class="form-label">Quick Period</label>
            <select class="form-control" id="reportPeriod">
                <option value="">Custom Range</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="quarter">This Quarter</option>
                <option value="year">This Year</option>
            </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="button" class="btn btn-primary w-100" onclick="loadReports()">
                <i class="fas fa-sync me-1"></i>Update Reports
            </button>
        </div>
    </div>
</div>

<!-- Key Metrics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value" id="totalAttendance">0</div>
            <div class="metric-label">Total Attendance Records</div>
            <div class="metric-change" id="attendanceChange">
                <i class="fas fa-arrow-up"></i> +5.2% from last period
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
            <div class="metric-value" id="averageWorkingHours">0.0</div>
            <div class="metric-label">Average Working Hours</div>
            <div class="metric-change" id="workingHoursChange">
                <i class="fas fa-arrow-up"></i> +2.1% from last period
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);">
            <div class="metric-value" id="attendanceRate">0%</div>
            <div class="metric-label">Attendance Rate</div>
            <div class="metric-change" id="attendanceRateChange">
                <i class="fas fa-arrow-down"></i> -1.2% from last period
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card" style="background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);">
            <div class="metric-value" id="lateArrivals">0</div>
            <div class="metric-label">Late Arrivals</div>
            <div class="metric-change" id="lateArrivalsChange">
                <i class="fas fa-arrow-down"></i> -8.3% from last period
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row">
    <div class="col-md-8">
        <div class="report-card">
            <h5><i class="fas fa-chart-line me-2"></i>Attendance Trend</h5>
            <div class="chart-container">
                <canvas id="attendanceTrendChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="report-card">
            <h5><i class="fas fa-chart-pie me-2"></i>Department Distribution</h5>
            <div class="chart-container">
                <canvas id="departmentChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="row">
    <div class="col-md-6">
        <div class="report-card">
            <h5><i class="fas fa-clock me-2"></i>Working Hours Distribution</h5>
            <div class="chart-container">
                <canvas id="workingHoursChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="report-card">
            <h5><i class="fas fa-calendar-week me-2"></i>Weekly Attendance Pattern</h5>
            <div class="chart-container">
                <canvas id="weeklyPatternChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Department Statistics -->
<div class="row">
    <div class="col-md-8">
        <div class="report-card">
            <h5><i class="fas fa-building me-2"></i>Department Performance</h5>
            <div id="departmentStats">
                <!-- Department statistics will be loaded here -->
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="report-card">
            <h5><i class="fas fa-trophy me-2"></i>Top Performers</h5>
            <div id="topPerformers">
                <!-- Top performers will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Detailed Reports -->
<div class="row">
    <div class="col-12">
        <div class="report-card">
            <h5><i class="fas fa-file-alt me-2"></i>Generate Detailed Reports</h5>
            <div class="row">
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-users fa-3x text-primary mb-3"></i>
                            <h6>Employee Summary Report</h6>
                            <p class="text-muted small">Comprehensive employee attendance summary</p>
                            <button type="button" class="btn btn-primary btn-sm" onclick="generateEmployeeReport()">
                                Generate Report
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-building fa-3x text-success mb-3"></i>
                            <h6>Department Analysis</h6>
                            <p class="text-muted small">Department-wise attendance analysis</p>
                            <button type="button" class="btn btn-success btn-sm" onclick="generateDepartmentReport()">
                                Generate Report
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-chart-bar fa-3x text-warning mb-3"></i>
                            <h6>Payroll Report</h6>
                            <p class="text-muted small">Working hours for payroll processing</p>
                            <button type="button" class="btn btn-warning btn-sm" onclick="generatePayrollReport()">
                                Generate Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let charts = {};

document.addEventListener('DOMContentLoaded', function() {
    initializeReports();
    setupEventListeners();
});

function initializeReports() {
    // Set default date range (current month)
    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    
    document.getElementById('reportDateFrom').value = firstDay.toISOString().split('T')[0];
    document.getElementById('reportDateTo').value = lastDay.toISOString().split('T')[0];
    
    loadReports();
}

function setupEventListeners() {
    document.getElementById('reportPeriod').addEventListener('change', function() {
        if (this.value) {
            setQuickPeriod(this.value);
        }
    });
}

function setQuickPeriod(period) {
    const now = new Date();
    let fromDate, toDate;
    
    switch (period) {
        case 'today':
            fromDate = toDate = now;
            break;
        case 'week':
            fromDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
            toDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay() + 6);
            break;
        case 'month':
            fromDate = new Date(now.getFullYear(), now.getMonth(), 1);
            toDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            break;
        case 'quarter':
            const quarter = Math.floor(now.getMonth() / 3);
            fromDate = new Date(now.getFullYear(), quarter * 3, 1);
            toDate = new Date(now.getFullYear(), quarter * 3 + 3, 0);
            break;
        case 'year':
            fromDate = new Date(now.getFullYear(), 0, 1);
            toDate = new Date(now.getFullYear(), 11, 31);
            break;
    }
    
    document.getElementById('reportDateFrom').value = fromDate.toISOString().split('T')[0];
    document.getElementById('reportDateTo').value = toDate.toISOString().split('T')[0];
    
    loadReports();
}

async function loadReports() {
    try {
        showLoading();
        
        const filters = {
            date_from: document.getElementById('reportDateFrom').value,
            date_to: document.getElementById('reportDateTo').value,
            department: document.getElementById('reportDepartment').value
        };
        
        // Load all report data
        await Promise.all([
            loadMetrics(filters),
            loadAttendanceTrend(filters),
            loadDepartmentDistribution(filters),
            loadWorkingHoursDistribution(filters),
            loadWeeklyPattern(filters),
            loadDepartmentStats(filters),
            loadTopPerformers(filters)
        ]);
        
        showStatus('Reports updated successfully', 'success');
    } catch (error) {
        console.error('Error loading reports:', error);
        showStatus('Failed to load reports', 'danger');
    } finally {
        hideLoading();
    }
}

async function loadMetrics(filters) {
    try {
        const queryString = new URLSearchParams(filters).toString();
        const response = await fetch(`/api/reports/metrics?${queryString}`);
        
        if (response.ok) {
            const metrics = await response.json();
            updateMetrics(metrics);
        }
    } catch (error) {
        console.error('Error loading metrics:', error);
    }
}

function updateMetrics(metrics) {
    document.getElementById('totalAttendance').textContent = metrics.total_attendance || 0;
    document.getElementById('averageWorkingHours').textContent = (metrics.average_working_hours || 0).toFixed(1);
    document.getElementById('attendanceRate').textContent = `${(metrics.attendance_rate || 0).toFixed(1)}%`;
    document.getElementById('lateArrivals').textContent = metrics.late_arrivals || 0;
    
    // Update change indicators
    updateChangeIndicator('attendanceChange', metrics.attendance_change);
    updateChangeIndicator('workingHoursChange', metrics.working_hours_change);
    updateChangeIndicator('attendanceRateChange', metrics.attendance_rate_change);
    updateChangeIndicator('lateArrivalsChange', metrics.late_arrivals_change);
}

function updateChangeIndicator(elementId, change) {
    const element = document.getElementById(elementId);
    const value = change || 0;
    const isPositive = value >= 0;
    
    element.className = `metric-change ${isPositive ? 'trend-up' : 'trend-down'}`;
    element.innerHTML = `
        <i class="fas fa-arrow-${isPositive ? 'up' : 'down'}"></i>
        ${isPositive ? '+' : ''}${value.toFixed(1)}% from last period
    `;
}

async function loadAttendanceTrend(filters) {
    try {
        const queryString = new URLSearchParams(filters).toString();
        const response = await fetch(`/api/reports/attendance-trend?${queryString}`);
        
        if (response.ok) {
            const data = await response.json();
            createAttendanceTrendChart(data);
        }
    } catch (error) {
        console.error('Error loading attendance trend:', error);
    }
}

function createAttendanceTrendChart(data) {
    const ctx = document.getElementById('attendanceTrendChart').getContext('2d');
    
    if (charts.attendanceTrend) {
        charts.attendanceTrend.destroy();
    }
    
    charts.attendanceTrend = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels || [],
            datasets: [{
                label: 'Daily Attendance',
                data: data.attendance || [],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Average Working Hours',
                data: data.working_hours || [],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Employees'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Working Hours'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
}

async function loadDepartmentDistribution(filters) {
    try {
        const queryString = new URLSearchParams(filters).toString();
        const response = await fetch(`/api/reports/department-distribution?${queryString}`);
        
        if (response.ok) {
            const data = await response.json();
            createDepartmentChart(data);
        }
    } catch (error) {
        console.error('Error loading department distribution:', error);
    }
}

function createDepartmentChart(data) {
    const ctx = document.getElementById('departmentChart').getContext('2d');
    
    if (charts.department) {
        charts.department.destroy();
    }
    
    charts.department = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.labels || [],
            datasets: [{
                data: data.values || [],
                backgroundColor: [
                    '#0d6efd', '#28a745', '#ffc107', '#dc3545',
                    '#17a2b8', '#6f42c1', '#fd7e14', '#20c997'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                }
            }
        }
    });
}

async function loadWorkingHoursDistribution(filters) {
    try {
        const queryString = new URLSearchParams(filters).toString();
        const response = await fetch(`/api/reports/working-hours-distribution?${queryString}`);
        
        if (response.ok) {
            const data = await response.json();
            createWorkingHoursChart(data);
        }
    } catch (error) {
        console.error('Error loading working hours distribution:', error);
    }
}

function createWorkingHoursChart(data) {
    const ctx = document.getElementById('workingHoursChart').getContext('2d');
    
    if (charts.workingHours) {
        charts.workingHours.destroy();
    }
    
    charts.workingHours = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels || [],
            datasets: [{
                label: 'Number of Employees',
                data: data.values || [],
                backgroundColor: 'rgba(13, 110, 253, 0.6)',
                borderColor: '#0d6efd',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Employees'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Working Hours Range'
                    }
                }
            }
        }
    });
}

async function loadWeeklyPattern(filters) {
    try {
        const queryString = new URLSearchParams(filters).toString();
        const response = await fetch(`/api/reports/weekly-pattern?${queryString}`);
        
        if (response.ok) {
            const data = await response.json();
            createWeeklyPatternChart(data);
        }
    } catch (error) {
        console.error('Error loading weekly pattern:', error);
    }
}

function createWeeklyPatternChart(data) {
    const ctx = document.getElementById('weeklyPatternChart').getContext('2d');
    
    if (charts.weeklyPattern) {
        charts.weeklyPattern.destroy();
    }
    
    charts.weeklyPattern = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
            datasets: [{
                label: 'Average Attendance',
                data: data.attendance || [],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.2)',
                pointBackgroundColor: '#0d6efd',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#0d6efd'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Attendance Percentage'
                    }
                }
            }
        }
    });
}

async function loadDepartmentStats(filters) {
    try {
        const queryString = new URLSearchParams(filters).toString();
        const response = await fetch(`/api/reports/department-stats?${queryString}`);
        
        if (response.ok) {
            const data = await response.json();
            displayDepartmentStats(data);
        }
    } catch (error) {
        console.error('Error loading department stats:', error);
    }
}

function displayDepartmentStats(stats) {
    const container = document.getElementById('departmentStats');
    container.innerHTML = '';
    
    stats.forEach(dept => {
        const div = document.createElement('div');
        div.className = 'department-stats';
        div.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1">${dept.department}</h6>
                    <small class="text-muted">${dept.employee_count} employees</small>
                </div>
                <div class="text-end">
                    <div class="fw-bold">${dept.attendance_rate}%</div>
                    <small class="text-muted">Attendance Rate</small>
                </div>
            </div>
            <div class="progress mt-2" style="height: 8px;">
                <div class="progress-bar" role="progressbar" 
                     style="width: ${dept.attendance_rate}%" 
                     aria-valuenow="${dept.attendance_rate}" 
                     aria-valuemin="0" aria-valuemax="100">
                </div>
            </div>
        `;
        container.appendChild(div);
    });
}

async function loadTopPerformers(filters) {
    try {
        const queryString = new URLSearchParams(filters).toString();
        const response = await fetch(`/api/reports/top-performers?${queryString}`);
        
        if (response.ok) {
            const data = await response.json();
            displayTopPerformers(data);
        }
    } catch (error) {
        console.error('Error loading top performers:', error);
    }
}

function displayTopPerformers(performers) {
    const container = document.getElementById('topPerformers');
    container.innerHTML = '';
    
    performers.forEach((performer, index) => {
        const div = document.createElement('div');
        div.className = 'employee-rank';
        div.innerHTML = `
            <div class="rank-number">${index + 1}</div>
            <div class="flex-grow-1">
                <div class="fw-bold">${performer.name}</div>
                <small class="text-muted">${performer.department}</small>
            </div>
            <div class="text-end">
                <div class="fw-bold text-success">${performer.attendance_rate}%</div>
                <small class="text-muted">Attendance</small>
            </div>
        `;
        container.appendChild(div);
    });
}

async function generateEmployeeReport() {
    try {
        showLoading();
        
        const filters = {
            date_from: document.getElementById('reportDateFrom').value,
            date_to: document.getElementById('reportDateTo').value,
            department: document.getElementById('reportDepartment').value,
            report_type: 'employee_summary'
        };
        
        const queryString = new URLSearchParams(filters).toString();
        const response = await fetch(`/api/reports/generate?${queryString}`);
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Employee_Summary_Report_${new Date().toISOString().split('T')[0]}.pdf`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showStatus('Employee report generated successfully', 'success');
        }
    } catch (error) {
        console.error('Error generating employee report:', error);
        showStatus('Failed to generate employee report', 'danger');
    } finally {
        hideLoading();
    }
}

async function generateDepartmentReport() {
    try {
        showLoading();
        
        const filters = {
            date_from: document.getElementById('reportDateFrom').value,
            date_to: document.getElementById('reportDateTo').value,
            department: document.getElementById('reportDepartment').value,
            report_type: 'department_analysis'
        };
        
        const queryString = new URLSearchParams(filters).toString();
        const response = await fetch(`/api/reports/generate?${queryString}`);
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Department_Analysis_Report_${new Date().toISOString().split('T')[0]}.pdf`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showStatus('Department report generated successfully', 'success');
        }
    } catch (error) {
        console.error('Error generating department report:', error);
        showStatus('Failed to generate department report', 'danger');
    } finally {
        hideLoading();
    }
}

async function generatePayrollReport() {
    try {
        showLoading();
        
        const filters = {
            date_from: document.getElementById('reportDateFrom').value,
            date_to: document.getElementById('reportDateTo').value,
            department: document.getElementById('reportDepartment').value,
            report_type: 'payroll'
        };
        
        const queryString = new URLSearchParams(filters).toString();
        const response = await fetch(`/api/reports/generate?${queryString}`);
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Payroll_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showStatus('Payroll report generated successfully', 'success');
        }
    } catch (error) {
        console.error('Error generating payroll report:', error);
        showStatus('Failed to generate payroll report', 'danger');
    } finally {
        hideLoading();
    }
}
</script>
{% endblock %} 