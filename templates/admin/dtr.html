{% extends "base.html" %}

{% block title %}DTR Generation{% endblock %}

{% block extra_css %}
<style>
    .snapshot-img {
        max-width: 100px;
        border-radius: 5px;
        margin-top: 5px;
    }

    @media print {
        body * {
            visibility: hidden;
        }
        .printable-area, .printable-area * {
            visibility: visible;
        }
        .printable-area {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
        .no-print {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4 no-print">
    <div class="col-12">
        <h2>
                <i class="fas fa-calendar-alt me-2"></i>Daily Time Record (DTR) Generation
        </h2>
            <p class="text-muted">Generate a DTR for a specific employee and date range.</p>
    </div>
</div>

    <div class="card no-print">
        <div class="card-body">
            <form method="POST" action="{{ url_for('admin.dtr_generation') }}" id="dtrForm">
                <div class="row g-3">
        <div class="col-md-3">
                        <label for="department" class="form-label">Department</label>
                        <select id="department" name="department" class="form-select">
                            <option value="">All Departments</option>
                            {% for dept in departments %}
                                <option value="{{ dept }}" {% if request.form.department == dept %}selected{% endif %}>{{ dept }}</option>
                            {% endfor %}
                        </select>
        </div>
                    <div class="col-md-4">
                        <label for="employee_id" class="form-label">Employee</label>
                        <select id="employee_id" name="employee_id" class="form-select" required>
                            <option value="">-- Select an Employee --</option>
                            {% for emp in employees %}
                                <option value="{{ emp.id }}" data-department="{{ emp.department }}" {% if selected_employee and selected_employee.id == emp.id %}selected{% endif %}>
                                    {{ emp.full_name }} ({{ emp.employee_number }})
                                </option>
                            {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
                        <label for="start_date" class="form-label">Start Date</label>
                        <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date or '' }}" required>
                    </div>
                    <div class="col-md-2">
                        <label for="end_date" class="form-label">End Date</label>
                        <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date or '' }}" required>
        </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
            </form>
        </div>
    </div>
    
    {% if error %}
        <div class="alert alert-danger mt-4 no-print">{{ error }}</div>
    {% endif %}

    {% if summary_data %}
        <div id="dtr-data" data-selected-employee-id="{{ selected_employee.id if selected_employee else '' }}"></div>
        <div class="card mt-4 printable-area">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>
                    DTR for: <strong>{{ selected_employee.full_name }}</strong> 
                    <span class="text-muted">({{ start_date }} to {{ end_date }})</span>
                </h4>
                <button class="btn btn-secondary no-print" onclick="window.print()">
                    <i class="fas fa-print me-2"></i>Print DTR
                </button>
            </div>
            <div class="card-body">
                <!-- Summary Table -->
                <h5 class="mt-3">Attendance Summary</h5>
    <div class="table-responsive">
                    <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th>Date</th>
                    <th>Time In</th>
                    <th>Time Out</th>
                                <th>Total Hours</th>
                </tr>
            </thead>
                        <tbody>
                            {% for row in summary_data %}
                            <tr>
                                <td>{{ row.date.strftime('%Y-%m-%d') }} ({{ row.date.strftime('%A') }})</td>
                                <td>{{ row.time_in }}</td>
                                <td>{{ row.time_out }}</td>
                                <td>{{ row.total_hours }}</td>
                            </tr>
                            {% endfor %}
            </tbody>
        </table>
    </div>
    
                <!-- Detailed Table with Images -->
                <h5 class="mt-4">Detailed Logs with Snapshots</h5>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>Date</th>
                                <th>Time In & Snapshot</th>
                                <th>Time Out & Snapshot</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day, data in detailed_data.items() %}
                            <tr>
                                <td>{{ day.strftime('%Y-%m-%d') }} ({{ day.strftime('%A') }})</td>
                                <td>
                                    {% if data.in %}
                                        <strong>{{ data.in.strftime('%H:%M:%S') }}</strong><br>
                                        {% if data.in_image %}
                                            <img src="data:image/jpeg;base64,{{ data.in_image | safe }}" alt="Time In Snapshot" class="snapshot-img">
                                        {% else %}
                                            <small class="text-muted">No snapshot</small>
                                        {% endif %}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>
                                    {% if data.out %}
                                        <strong>{{ data.out.strftime('%H:%M:%S') }}</strong><br>
                                         {% if data.out_image %}
                                            <img src="data:image/jpeg;base64,{{ data.out_image | safe }}" alt="Time Out Snapshot" class="snapshot-img">
                                        {% else %}
                                            <small class="text-muted">No snapshot</small>
                                        {% endif %}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="3" class="text-center">No attendance records found for this period.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const departmentSelect = document.getElementById('department');
    const employeeSelect = document.getElementById('employee_id');
    const allEmployees = Array.from(employeeSelect.options);
    const dtrData = document.getElementById('dtr-data');

    function filterEmployees() {
        const selectedDepartment = departmentSelect.value;
        
        const currentEmployee = employeeSelect.value;

        // Clear current options
        employeeSelect.innerHTML = '';
        employeeSelect.add(allEmployees[0]); // Add back the default "-- Select --" option

        // Filter and add relevant employees
        allEmployees.slice(1).forEach(option => {
            if (selectedDepartment === '' || option.dataset.department === selectedDepartment) {
                employeeSelect.add(option.cloneNode(true));
            }
        });
        
        employeeSelect.value = currentEmployee;
    }

    departmentSelect.addEventListener('change', filterEmployees);
    
    // Initial filter on page load if a department is pre-selected
    filterEmployees();
    
    if(dtrData) {
        const selectedEmployeeId = dtrData.dataset.selectedEmployeeId;
        if (selectedEmployeeId) {
            employeeSelect.value = selectedEmployeeId;
        }
    }
});
</script>
{% endblock %} 