{% extends "base.html" %}

{% block title %}Attendance - Time In/Out{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-header bg-primary text-white text-center">
                <h3 class="mb-0">
                    <i class="fas fa-clock me-2"></i>
                    Employee Attendance
                </h3>
            </div>
            <div class="card-body text-center">
                <div class="mb-4">
                    <p class="text-muted">Please select your attendance action:</p>
                </div>
                
                <div class="row">
                    <div class="col-6">
                        <button class="btn btn-success attendance-btn w-100" onclick="startAttendance('in')">
                            <i class="fas fa-sign-in-alt fa-2x mb-2"></i><br>
                            <strong>TIME IN</strong>
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-danger attendance-btn w-100" onclick="startAttendance('out')">
                            <i class="fas fa-sign-out-alt fa-2x mb-2"></i><br>
                            <strong>TIME OUT</strong>
                        </button>
                    </div>
                </div>
                
                <div class="mt-4">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Instructions:</strong>
                        <ol class="mb-0 mt-2 text-start">
                            <li>Click either "TIME IN" or "TIME OUT" button</li>
                            <li>Show your employee ID QR code to the camera</li>
                            <li>Look at the camera for face verification</li>
                            <li>Wait for confirmation</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Today's Status -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-day me-2"></i>
                    Today's Attendance Status
                </h5>
            </div>
            <div class="card-body">
                <div id="todayStatus">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading today's status...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- QR Scanner Modal -->
<div class="modal fade" id="qrScannerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-qrcode me-2"></i>
                    Scan QR Code
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- QR Camera Section -->
                    <div class="col-md-7">
                        <h5 class="mb-3">
                            <i class="fas fa-qrcode me-2"></i>Scan QR Code
                        </h5>
                        <div class="camera-container">
                            <video id="qrVideo" autoplay playsinline></video>
                            <canvas id="qrCanvas" style="display: none;"></canvas>
                            <div class="camera-overlay">
                                <div class="position-absolute top-50 start-50 translate-middle">
                                    <div class="border border-success border-3 rounded" style="width: 200px; height: 200px;">
                                        <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center">
                                            <i class="fas fa-qrcode text-success fa-3x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <p class="text-muted">Position your employee QR code within the frame</p>
                            <div id="qrStatus" class="alert alert-info" style="display: none;">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                <span id="qrStatusText">Scanning...</span>
                            </div>
                            <!-- Upload Option -->
                            <div class="mt-3">
                                <label for="qrFileInput" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-upload me-2"></i>Upload QR Image
                                </label>
                                <input type="file" id="qrFileInput" accept="image/*" style="display: none;" onchange="processQrFile(event)">
                            </div>
                        </div>
                    </div>

                    <!-- Numeric Keypad Section -->
                    <div class="col-md-5">
                        <h5 class="mb-3">
                            <i class="fas fa-keyboard me-2"></i>Enter Employee ID
                        </h5>
                        
                        <!-- Display Screen -->
                        <div class="keypad-display mb-3">
                            <input type="text" id="employeeIdInput" class="form-control form-control-lg text-center" 
                                   placeholder="Employee ID" readonly style="font-size: 1.2rem; letter-spacing: 2px; background-color: #f8f9fa;">
                        </div>
                        
                        <!-- Numeric Keypad -->
                        <div class="numeric-keypad">
                            <div class="row g-1 justify-content-center">
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100 keypad-btn" data-value="1">1</button>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100 keypad-btn" data-value="2">2</button>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100 keypad-btn" data-value="3">3</button>
                                </div>
                            </div>
                            <div class="row g-1 justify-content-center mt-1">
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100 keypad-btn" data-value="4">4</button>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100 keypad-btn" data-value="5">5</button>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100 keypad-btn" data-value="6">6</button>
                                </div>
                            </div>
                            <div class="row g-1 justify-content-center mt-1">
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100 keypad-btn" data-value="7">7</button>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100 keypad-btn" data-value="8">8</button>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100 keypad-btn" data-value="9">9</button>
                                </div>
                            </div>
                            <div class="row g-1 justify-content-center mt-1">
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-secondary w-100" onclick="backspaceEmployeeId()">
                                        <i class="fas fa-backspace"></i>
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100 keypad-btn" data-value="0">0</button>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-danger w-100" onclick="clearEmployeeId()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="mt-3">
                            <button type="button" class="btn btn-success w-100" onclick="submitEmployeeId()" disabled id="submitEmployeeIdBtn">
                                <i class="fas fa-check me-2"></i>Confirm ID
                            </button>
                        </div>

                        <!-- Status Display -->
                        <div id="keypadStatus" class="alert alert-info mt-3" style="display: none;">
                            <span id="keypadStatusText">Processing...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="retryQrScan()" id="retryQrBtn">
                    <i class="fas fa-redo me-2"></i>Retry Scan
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Face Verification Modal -->
<div class="modal fade" id="faceVerificationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-check me-2"></i>
                    Face Verification
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="camera-container">
                    <video id="faceVideo" class="camera-preview-video" autoplay playsinline></video>
                    <canvas id="faceCanvas" style="display: none;"></canvas>
                    <div class="camera-overlay">
                        <div class="position-absolute top-50 start-50 translate-middle">
                            <div class="border border-primary border-3 rounded-circle" style="width: 200px; height: 200px;">
                                <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center">
                                    <i class="fas fa-user text-primary fa-3x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <p class="text-muted">Position your face clearly in the camera view. Face will be captured automatically in <span id="countdownDisplay">3</span> seconds.</p>
                    <div id="faceStatus" class="alert alert-info" style="display: none;">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        <span id="faceStatusText">Ready to capture...</span>
                    </div>
                    <div class="progress mt-2" style="display: none;" id="faceProgress">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="mt-3">
                        <div id="countdownContainer" class="d-none">
                            <div class="countdown-circle">
                                <span id="countdownNumber">3</span>
                            </div>
                        </div>
                        <button type="button" class="btn btn-success btn-lg" id="captureFaceBtn" onclick="captureFaceImage()" style="display: none;">
                            <i class="fas fa-camera me-2"></i>Capture Face
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Similarity Result Modal -->
<div class="modal fade" id="similarityResultModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" id="resultModalHeader">
                <h4 class="modal-title" id="resultModalTitle">
                    <i class="fas fa-user-check me-2"></i>
                    Face Verification Result
                </h4>
            </div>
            <div class="modal-body text-center" id="resultModalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-primary btn-lg" id="resultModalClose">
                    <i class="fas fa-check me-2"></i>Continue
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
#similarityResultModal .modal-dialog {
    max-width: 1200px;
}

#similarityResultModal .display-3 {
    font-size: 4rem;
    font-weight: bold;
}

.similarity-score-card {
    border-width: 3px !important;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.pulse-animation {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.attendance-success {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.attendance-failure {
    background: linear-gradient(135deg, #dc3545, #fd7e14);
    color: white;
}

/* Numeric Keypad Styling */
.numeric-keypad .btn {
    height: 45px;
    font-size: 1.2rem;
    font-weight: bold;
}

.keypad-display input {
    border: 2px solid #e9ecef;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.keypad-display input:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

.upload-area {
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.upload-area:hover {
    border-color: #007bff !important;
    background-color: #f8f9fa;
}

/* Countdown Circle Styles */
.countdown-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(45deg, #007bff, #0056b3);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    animation: pulse 1s infinite;
}

.countdown-circle span {
    color: white;
    font-size: 2rem;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
}

@keyframes pulse {
    0% {
        transform: scale(1);
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }
    50% {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }
}

.countdown-circle.countdown-2 {
    background: linear-gradient(45deg, #ffc107, #e0a800);
    box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
}

.countdown-circle.countdown-1 {
    background: linear-gradient(45deg, #dc3545, #c82333);
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
}

.countdown-circle.countdown-0 {
    background: linear-gradient(45deg, #28a745, #1e7e34);
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentAttendanceType = null;
let qrStream = null;
let faceStream = null;
let qrScanInterval = null;
let faceCaptureInterval = null;
let capturedImages = [];
let snapshotCount = 1; // Only 1 image for attendance verification
let currentEmployee = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadTodayStatus();
    setupKeypadListeners();
});

// Setup keypad event listeners
function setupKeypadListeners() {
    document.querySelectorAll('.keypad-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const value = this.getAttribute('data-value');
            appendToEmployeeId(value);
        });
    });
    
    // Add keyboard support for numeric keypad
    document.addEventListener('keydown', function(event) {
        // Only handle keypad input when the QR scanner modal is open
        const modal = document.getElementById('qrScannerModal');
        if (!modal || !modal.classList.contains('show')) {
            return;
        }
        
        // Handle number keys (0-9)
        if (event.key >= '0' && event.key <= '9') {
            event.preventDefault();
            appendToEmployeeId(event.key);
        }
        // Handle backspace
        else if (event.key === 'Backspace') {
            event.preventDefault();
            backspaceEmployeeId();
        }
        // Handle escape (clear all)
        else if (event.key === 'Escape') {
            event.preventDefault();
            clearEmployeeId();
        }
        // Handle enter (submit)
        else if (event.key === 'Enter') {
            event.preventDefault();
            const submitBtn = document.getElementById('submitEmployeeIdBtn');
            if (!submitBtn.disabled) {
                submitEmployeeId();
            }
        }
    });
}

// Utility functions
function showStatus(message, type = 'info') {
    console.log(`Status (${type}): ${message}`);
    
    // Create or update status alert
    let statusAlert = document.getElementById('globalStatus');
    if (!statusAlert) {
        statusAlert = document.createElement('div');
        statusAlert.id = 'globalStatus';
        statusAlert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        statusAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        document.body.appendChild(statusAlert);
    } else {
        statusAlert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    }
    
    statusAlert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        if (statusAlert && statusAlert.parentNode) {
            statusAlert.remove();
        }
    }, 5000);
}

async function apiCall(url, options = {}) {
    try {
        const response = await fetch(url, {
            headers: {
                'Content-Type': 'application/json',
                ...options.headers
            },
            ...options
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error('API call failed:', error);
        throw error;
    }
}

async function loadTodayStatus() {
    try {
        const response = await apiCall('/attendance/api/get-attendance-status');
        if (response.success) {
            displayTodayStatus(response);
        }
    } catch (error) {
        console.error('Error loading today status:', error);
    }
}

function displayTodayStatus(data) {
    const container = document.getElementById('todayStatus');
    
    let html = `
        <div class="row text-center">
            <div class="col-4">
                <div class="border-end">
                    <h4 class="text-primary">${data.active_employees}</h4>
                    <small class="text-muted">Active Employees</small>
                </div>
            </div>
            <div class="col-4">
                <div class="border-end">
                    <h4 class="text-success">${data.attendance_summary.length}</h4>
                    <small class="text-muted">Present Today</small>
                </div>
            </div>
            <div class="col-4">
                <h4 class="text-info">${data.recent_attendances.length}</h4>
                <small class="text-muted">Recent Records</small>
            </div>
        </div>
    `;
    
    if (data.recent_attendances.length > 0) {
        html += `
            <div class="mt-3">
                <h6>Recent Activity:</h6>
                <div class="list-group list-group-flush">
        `;
        
        data.recent_attendances.slice(0, 5).forEach(att => {
            const time = new Date(att.timestamp).toLocaleTimeString();
            const type = att.type === 'in' ? 'Time In' : 'Time Out';
            const badgeClass = att.type === 'in' ? 'bg-success' : 'bg-danger';
            
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${att.employee_name}</strong>
                        <br><small class="text-muted">${time}</small>
                    </div>
                    <span class="badge ${badgeClass}">${type}</span>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

function startAttendance(type) {
    currentAttendanceType = type;
    showStatus(`Starting ${type === 'in' ? 'Time In' : 'Time Out'} process...`, 'info');
    
    // Show QR scanner modal
    const modal = new bootstrap.Modal(document.getElementById('qrScannerModal'));
    modal.show();
    
    // Start QR scanning
    startQrScanning();
}

async function startQrScanning() {
    try {
        const video = document.getElementById('qrVideo');
        const canvas = document.getElementById('qrCanvas');
        const status = document.getElementById('qrStatus');
        const statusText = document.getElementById('qrStatusText');
        
        // Get camera stream - default to front camera
        qrStream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: 'user', // Front-facing camera for easier QR scanning
                width: { ideal: 640 },
                height: { ideal: 480 }
            }
        });
        
        video.srcObject = qrStream;
        status.style.display = 'block';
        statusText.textContent = 'Scanning for QR code...';
        
        // Start scanning
        qrScanInterval = setInterval(async () => {
            try {
                // Skip if video is not ready
                if (video.videoWidth === 0 || video.videoHeight === 0) {
                    return;
                }
                
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0);
                
                const imageData = canvas.toDataURL('image/jpeg', 0.9);
                const base64Data = imageData.split(',')[1];
                
                // Skip if no valid image data
                if (!base64Data || base64Data.length < 100) {
                    return;
                }
                
                // Send to server for QR processing
                const response = await fetch('/attendance/api/process-qr-scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image: base64Data,
                        attendance_type: currentAttendanceType
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // QR code found and processed
                    clearInterval(qrScanInterval);
                    currentEmployee = data.employee;
                    
                    statusText.textContent = `QR code scanned! Employee: ${data.employee.full_name}`;
                    status.className = 'alert alert-success';
                    
                    // Stop QR stream
                    if (qrStream) {
                        qrStream.getTracks().forEach(track => track.stop());
                    }
                    
                    // Wait a moment then start face verification
                    setTimeout(() => {
                        bootstrap.Modal.getInstance(document.getElementById('qrScannerModal')).hide();
                        startFaceVerification();
                    }, 2000);
                    
                } else if (response.status === 400) {
                    // Log error but don't stop scanning
                    console.log('QR scan attempt failed:', data.error);
                }
            } catch (error) {
                console.error('QR scan error:', error);
            }
        }, 2000);
        
    } catch (error) {
        console.error('Error starting QR scanner:', error);
        showStatus('Error accessing camera: ' + error.message, 'danger');
    }
}

function retryQrScan() {
    if (qrScanInterval) {
        clearInterval(qrScanInterval);
    }
    if (qrStream) {
        qrStream.getTracks().forEach(track => track.stop());
    }
    startQrScanning();
}

async function processQrFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    try {
        const statusDiv = document.getElementById('qrStatus');
        const statusText = document.getElementById('qrStatusText');
        
        // Show upload status
        statusDiv.style.display = 'block';
        statusDiv.className = 'alert alert-info';
        statusText.textContent = 'Processing uploaded QR code...';
        
        // Convert file to base64
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const imageData = e.target.result;
                const base64Data = imageData.split(',')[1];
                
                // Send to server for QR processing
                const response = await fetch('/attendance/api/process-qr-scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image: base64Data,
                        attendance_type: currentAttendanceType
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // QR code found and processed
                    if (qrScanInterval) {
                        clearInterval(qrScanInterval);
                    }
                    if (qrStream) {
                        qrStream.getTracks().forEach(track => track.stop());
                    }
                    
                    currentEmployee = data.employee;
                    
                    statusText.textContent = `QR code scanned! Employee: ${data.employee.full_name}`;
                    statusDiv.className = 'alert alert-success';
                    
                    // Wait a moment then start face verification
                    setTimeout(() => {
                        bootstrap.Modal.getInstance(document.getElementById('qrScannerModal')).hide();
                        startFaceVerification();
                    }, 2000);
                    
                } else {
                    statusText.textContent = data.error;
                    statusDiv.className = 'alert alert-danger';
                }
                
            } catch (error) {
                console.error('Error processing QR file:', error);
                statusText.textContent = 'Error processing QR code';
                statusDiv.className = 'alert alert-danger';
            }
        };
        
        reader.readAsDataURL(file);
        
    } catch (error) {
        console.error('Error reading file:', error);
        showStatus('Error reading QR code file', 'danger');
    }
}

// Numeric Keypad Functions
function appendToEmployeeId(digit) {
    const input = document.getElementById('employeeIdInput');
    const currentValue = input.value;
    
    // Limit to reasonable length (e.g., 10 characters)
    if (currentValue.length < 10) {
        input.value = currentValue + digit;
        updateSubmitButton();
    }
}

function backspaceEmployeeId() {
    const input = document.getElementById('employeeIdInput');
    input.value = input.value.slice(0, -1);
    updateSubmitButton();
}

function clearEmployeeId() {
    const input = document.getElementById('employeeIdInput');
    input.value = '';
    updateSubmitButton();
}

function updateSubmitButton() {
    const input = document.getElementById('employeeIdInput');
    const submitBtn = document.getElementById('submitEmployeeIdBtn');
    
    // Enable submit button only if there's at least one character
    if (input.value.trim().length > 0) {
        submitBtn.disabled = false;
        submitBtn.classList.remove('btn-secondary');
        submitBtn.classList.add('btn-success');
    } else {
        submitBtn.disabled = true;
        submitBtn.classList.remove('btn-success');
        submitBtn.classList.add('btn-secondary');
    }
}

async function submitEmployeeId() {
    const input = document.getElementById('employeeIdInput');
    const employeeNumber = input.value.trim();
    
    if (!employeeNumber) {
        showStatus('Please enter an employee ID', 'warning');
        return;
    }
    
    try {
        const statusDiv = document.getElementById('keypadStatus');
        const statusText = document.getElementById('keypadStatusText');
        const submitBtn = document.getElementById('submitEmployeeIdBtn');
        
        // Show loading state
        statusDiv.style.display = 'block';
        statusDiv.className = 'alert alert-info mt-3';
        statusText.textContent = 'Looking up employee...';
        submitBtn.disabled = true;
        
        // Look up employee by ID
        const response = await fetch('/attendance/api/lookup-employee', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                employee_number: employeeNumber,
                attendance_type: currentAttendanceType
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Employee found
            currentEmployee = data.employee;
            
            statusText.textContent = `Employee found: ${data.employee.full_name}`;
            statusDiv.className = 'alert alert-success mt-3';
            
            // Wait a moment then start face verification
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('qrScannerModal')).hide();
                startFaceVerification();
            }, 2000);
            
        } else {
            // Employee not found
            statusText.textContent = data.error || 'Employee not found';
            statusDiv.className = 'alert alert-danger mt-3';
            submitBtn.disabled = false;
        }
        
    } catch (error) {
        console.error('Error looking up employee:', error);
        showStatus('Error looking up employee: ' + error.message, 'danger');
        
        const submitBtn = document.getElementById('submitEmployeeIdBtn');
        submitBtn.disabled = false;
    }
}

async function startFaceVerification() {
    try {
        const video = document.getElementById('faceVideo');
        const canvas = document.getElementById('faceCanvas');
        const status = document.getElementById('faceStatus');
        const statusText = document.getElementById('faceStatusText');
        const progress = document.getElementById('faceProgress');
        const progressBar = progress.querySelector('.progress-bar');
        const countdownContainer = document.getElementById('countdownContainer');
        const countdownNumber = document.getElementById('countdownNumber');
        const countdownDisplay = document.getElementById('countdownDisplay');
        
        // Show face verification modal
        const modal = new bootstrap.Modal(document.getElementById('faceVerificationModal'));
        modal.show();
        
        // Get camera stream - default to front camera
        faceStream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: 'user', // Front-facing camera
                width: { ideal: 640 },
                height: { ideal: 480 }
            }
        });
        
        video.srcObject = faceStream;
        status.style.display = 'block';
        statusText.textContent = 'Camera ready. Positioning your face...';
        
        // Wait a moment for camera to stabilize, then start countdown
        setTimeout(() => {
            startCountdown();
        }, 1000);
        
        capturedImages = [];
        
    } catch (error) {
        console.error('Error starting face verification:', error);
        showStatus('Error accessing camera: ' + error.message, 'danger');
    }
}

function startCountdown() {
    const countdownContainer = document.getElementById('countdownContainer');
    const countdownNumber = document.getElementById('countdownNumber');
    const countdownDisplay = document.getElementById('countdownDisplay');
    const statusText = document.getElementById('faceStatusText');
    const countdownCircle = countdownContainer.querySelector('.countdown-circle');
    
    let countdown = 3;
    
    // Show countdown container
    countdownContainer.classList.remove('d-none');
    statusText.textContent = 'Get ready! Face will be captured automatically...';
    
    // Update countdown display in text
    countdownDisplay.textContent = countdown;
    
    const countdownInterval = setInterval(() => {
        countdown--;
        
        // Update countdown number
        countdownNumber.textContent = countdown;
        countdownDisplay.textContent = countdown;
        
        // Update circle color based on countdown
        countdownCircle.className = 'countdown-circle';
        if (countdown === 2) {
            countdownCircle.classList.add('countdown-2');
        } else if (countdown === 1) {
            countdownCircle.classList.add('countdown-1');
        } else if (countdown === 0) {
            countdownCircle.classList.add('countdown-0');
        }
        
        if (countdown <= 0) {
            clearInterval(countdownInterval);
            
            // Hide countdown and capture face automatically
            countdownContainer.classList.add('d-none');
            captureFaceImage();
        }
    }, 1000);
}

async function captureFaceImage() {
    try {
        const video = document.getElementById('faceVideo');
        const statusText = document.getElementById('faceStatusText');
        const progress = document.getElementById('faceProgress');
        const progressBar = progress.querySelector('.progress-bar');
        const captureBtn = document.getElementById('captureFaceBtn');
        
        // Hide capture button and show progress
        captureBtn.style.display = 'none';
        progress.style.display = 'block';
        statusText.textContent = 'Capturing and processing face...';
        
        // Capture the image
        const base64Data = captureBase64FromVideo(video, 0.8);
        capturedImages.push(base64Data);
        
        // Update progress to 100%
        progressBar.style.width = '100%';
        
        // Stop camera stream
        if (faceStream) {
            faceStream.getTracks().forEach(track => track.stop());
        }
        
        // Process face verification
        await processFaceVerification();
        
    } catch (error) {
        console.error('Face capture error:', error);
        showStatus('Error capturing face: ' + error.message, 'danger');
        
        // Re-show capture button on error
        document.getElementById('captureFaceBtn').style.display = 'block';
        document.getElementById('faceProgress').style.display = 'none';
    }
}

async function processFaceVerification() {
    try {
        const statusText = document.getElementById('faceStatusText');
        statusText.textContent = 'Processing face verification...';
        
        // Send images to server
        const response = await fetch('/attendance/api/process-face-verification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                images: capturedImages,
                snapshot_count: snapshotCount
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Success! Show detailed similarity information
            const similarityPercent = (data.similarity_score * 100).toFixed(1);
            const employeeName = currentEmployee ? currentEmployee.full_name : 'Employee';
            const attendanceType = data.attendance.type.toUpperCase();
            
            // Display large success modal with similarity score
            showSimilarityResultModal({
                success: true,
                employeeName: employeeName,
                attendanceType: attendanceType,
                similarityScore: data.similarity_score,
                similarityPercent: similarityPercent,
                message: data.message,
                attendanceDetails: data.attendance,
                detailedResults: data.detailed_results || []
            });
            
            // Close face verification modal
            bootstrap.Modal.getInstance(document.getElementById('faceVerificationModal')).hide();
            
        } else {
            // Failed - show detailed error
            const similarityPercent = data.similarity_score ? (data.similarity_score * 100).toFixed(1) : 'N/A';
            
            // Show failure modal with details
            showSimilarityResultModal({
                success: false,
                employeeName: currentEmployee ? currentEmployee.full_name : 'Employee',
                attendanceType: currentAttendanceType.toUpperCase(),
                similarityScore: data.similarity_score || 0,
                similarityPercent: similarityPercent,
                message: data.error,
                error: data.error,
                detailedResults: data.detailed_results || []
            });
            
            // Close face verification modal
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('faceVerificationModal')).hide();
            }, 1000);
        }
        
    } catch (error) {
        console.error('Face verification error:', error);
        showStatus('Face verification failed: ' + error.message, 'danger');
    }
}

function showSimilarityResultModal(result) {
    const modal = document.getElementById('similarityResultModal');
    const header = document.getElementById('resultModalHeader');
    const title = document.getElementById('resultModalTitle');
    const body = document.getElementById('resultModalBody');
    const closeButton = document.getElementById('resultModalClose');
    
    if (result.success) {
        // Success styling
        header.className = 'modal-header bg-success text-white';
        title.innerHTML = '<i class="fas fa-check-circle me-2"></i>Attendance Recorded Successfully!';
        
        // Determine similarity color
        let similarityColor = 'success';
        if (result.similarityScore >= 0.95) {
            similarityColor = 'success';
        } else if (result.similarityScore >= 0.9) {
            similarityColor = 'warning';
        } else {
            similarityColor = 'danger';
        }
        
        body.innerHTML = `
            <div class="row">
                <div class="col-12 mb-4">
                    <h2 class="text-success">
                        <i class="fas fa-check-circle fa-3x mb-3"></i><br>
                        ${result.attendanceType} RECORDED
                    </h2>
                    <h4>${result.employeeName}</h4>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-${similarityColor} similarity-score-card pulse-animation">
                        <div class="card-header attendance-success">
                            <h5 class="mb-0">
                                <i class="fas fa-percentage me-2"></i>
                                Face Similarity Score
                            </h5>
                        </div>
                        <div class="card-body text-center">
                            <h1 class="display-3 text-${similarityColor} mb-0">${result.similarityPercent}%</h1>
                            <p class="text-muted">Confidence Level</p>
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar bg-${similarityColor} progress-bar-striped progress-bar-animated" style="width: ${result.similarityPercent}%"></div>
                            </div>
                            <small class="text-muted">Threshold: Auto-adjusted by AI</small>
                            <div class="mt-2">
                                <span class="badge bg-${similarityColor} fs-6">
                                    ${result.similarityScore >= 0.95 ? 'EXCELLENT' : result.similarityScore >= 0.9 ? 'GOOD' : 'POOR'} MATCH
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Attendance Details
                            </h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Type:</strong> ${result.attendanceType}</p>
                            <p><strong>Employee:</strong> ${result.employeeName}</p>
                            <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
                            <p><strong>Method:</strong> QR + Face Verification</p>
                            <p><strong>Status:</strong> <span class="badge bg-success">Verified</span></p>
                        </div>
                    </div>
                </div>
            </div>
            
            ${result.detailedResults && result.detailedResults.length > 0 ? `
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card border-secondary">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-list-ol me-2"></i>
                                Individual Image Results
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Image</th>
                                            <th>Status</th>
                                            <th>Similarity</th>
                                            <th>Face Confidence</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${result.detailedResults.map(detail => `
                                            <tr class="${detail.status === 'success' ? 'table-success' : detail.status === 'failed' ? 'table-warning' : 'table-danger'}">
                                                <td><strong>#${detail.image_index}</strong></td>
                                                <td>
                                                    <span class="badge ${detail.status === 'success' ? 'bg-success' : detail.status === 'failed' ? 'bg-warning' : 'bg-danger'}">
                                                        ${detail.status.toUpperCase()}
                                                    </span>
                                                </td>
                                                <td>${detail.similarity ? (detail.similarity * 100).toFixed(1) + '%' : 'N/A'}</td>
                                                <td>${detail.face_confidence ? (detail.face_confidence * 100).toFixed(1) + '%' : 'N/A'}</td>
                                                <td>
                                                    ${detail.error ? `<small class="text-danger">${detail.error}</small>` : 
                                                      detail.max_similarity ? `<small>Max: ${(detail.max_similarity * 100).toFixed(1)}%, Min: ${(detail.min_similarity * 100).toFixed(1)}%</small>` : ''}
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            ` : ''}
            </div>
            
            <div class="alert alert-success mt-4">
                <i class="fas fa-check-circle me-2"></i>
                ${result.message}
            </div>
        `;
        
        closeButton.className = 'btn btn-success btn-lg';
        closeButton.innerHTML = '<i class="fas fa-check me-2"></i>Continue';
        
    } else {
        // Failure styling
        header.className = 'modal-header bg-danger text-white';
        title.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Attendance Failed';
        
        body.innerHTML = `
            <div class="row">
                <div class="col-12 mb-4">
                    <h2 class="text-danger">
                        <i class="fas fa-times-circle fa-3x mb-3"></i><br>
                        VERIFICATION FAILED
                    </h2>
                    <h4>${result.employeeName}</h4>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-danger similarity-score-card">
                        <div class="card-header attendance-failure">
                            <h5 class="mb-0">
                                <i class="fas fa-percentage me-2"></i>
                                Face Similarity Score
                            </h5>
                        </div>
                        <div class="card-body text-center">
                            <h1 class="display-3 text-danger mb-0">${result.similarityPercent}%</h1>
                            <p class="text-muted">Confidence Level</p>
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar bg-danger" style="width: ${Math.max(0, parseFloat(result.similarityPercent))}%"></div>
                            </div>
                            <small class="text-muted">Threshold: Auto-adjusted by AI</small>
                            <div class="mt-2">
                                <span class="badge bg-danger fs-6">INSUFFICIENT MATCH</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                What to do next?
                            </h5>
                        </div>
                        <div class="card-body">
                            <ul class="text-start">
                                <li>Ensure good lighting</li>
                                <li>Position face clearly in camera</li>
                                <li>Remove glasses if necessary</li>
                                <li>Look directly at camera</li>
                                <li>Register more face photos if needed</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            ${result.detailedResults && result.detailedResults.length > 0 ? `
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-list-ol me-2"></i>
                                Individual Image Results (Detailed Analysis)
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Image</th>
                                            <th>Status</th>
                                            <th>Similarity</th>
                                            <th>Face Confidence</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${result.detailedResults.map(detail => `
                                            <tr class="${detail.status === 'success' ? 'table-success' : detail.status === 'failed' ? 'table-warning' : 'table-danger'}">
                                                <td><strong>#${detail.image_index}</strong></td>
                                                <td>
                                                    <span class="badge ${detail.status === 'success' ? 'bg-success' : detail.status === 'failed' ? 'bg-warning' : 'bg-danger'}">
                                                        ${detail.status.toUpperCase()}
                                                    </span>
                                                </td>
                                                <td>${detail.similarity ? (detail.similarity * 100).toFixed(1) + '%' : 'N/A'}</td>
                                                <td>${detail.face_confidence ? (detail.face_confidence * 100).toFixed(1) + '%' : 'N/A'}</td>
                                                <td>
                                                    ${detail.error ? `<small class="text-danger">${detail.error}</small>` : 
                                                      detail.max_similarity ? `<small>Max: ${(detail.max_similarity * 100).toFixed(1)}%, Min: ${(detail.min_similarity * 100).toFixed(1)}%</small>` : ''}
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            ` : ''}
            </div>
            
            <div class="alert alert-danger mt-4">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${result.message}
            </div>
        `;
        
        closeButton.className = 'btn btn-primary btn-lg';
        closeButton.innerHTML = '<i class="fas fa-redo me-2"></i>Try Again';
    }
    
    // Show modal
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    // Handle close button
    closeButton.onclick = function() {
        bootstrapModal.hide();
        loadTodayStatus(); // Refresh the attendance status
    };
}

// Cleanup when modals are closed
document.getElementById('qrScannerModal').addEventListener('hidden.bs.modal', function() {
    if (qrScanInterval) {
        clearInterval(qrScanInterval);
    }
    if (qrStream) {
        qrStream.getTracks().forEach(track => track.stop());
    }
    
    // Reset keypad and status
    clearEmployeeId();
    document.getElementById('keypadStatus').style.display = 'none';
    document.getElementById('qrStatus').style.display = 'none';
});

document.getElementById('faceVerificationModal').addEventListener('hidden.bs.modal', function() {
    if (faceCaptureInterval) {
        clearInterval(faceCaptureInterval);
    }
    if (faceStream) {
        faceStream.getTracks().forEach(track => track.stop());
    }
    
    // Reset UI elements
    document.getElementById('captureFaceBtn').style.display = 'none';
    document.getElementById('faceProgress').style.display = 'none';
    document.getElementById('countdownContainer').classList.add('d-none');
    document.getElementById('faceStatus').style.display = 'none';
});
</script>
{% endblock %} 